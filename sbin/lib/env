# -*- mode:shell-script -*-
[[ "${0}" != 'sbin/http-byob' ]] && printf '%s\n' "Don't do that." && exit 1
export HTTPD_USER
HTTPD_USER=$(logname)


###############
# DECLARATIONS
###############
declare -i DNS_PORT=53
declare -xi HTTPD_PORT=80

declare -xi DNSMASQ_LOG_PORT=9005
declare -xi HTTPD_LOG_PORT=9000

declare -xr HTTPD_VHOST_CUSTOM_LOG=/dev/null
declare -xr HTTPD_VHOST_ERROR_LOG=/dev/null


declare -xr HTTPD_SERVER_NAME="localhost"

declare -xr HOSTNAME="${HOSTNAME}"

# will only override what is allowed
source http_byob.cfg >/dev/null 2>&1



########################
# FIND EXECUTABLES
declare -r HTTPD_TMP=$(which httpd)
declare HTTPD="${HTTPD:=${HTTPD_TMP}}"

declare -r DNSMASQ_TMP=$(which dnsmasq)
declare DNSMASQ="${DNSMASQ:=${DNSMASQ_TMP}}"

declare -r APACHECTL_TMP=$(which apachectl)
declare APACHECTL="${APACHECTL:=${APACHECTL_TMP}}"

[[ ! -x "${HTTPD}" ]] && HTTPD=''
[[ ! -x "${DNSMASQ}" ]] && DNSMASQ=''
[[ ! -x "${APACHECTL}" ]] && APACHECTL=''

export eval exe=("${APACHECTL} ${DNSMASQ}")


#
declare -xr HTTP_SERVER_ROOT=$(dirname $(dirname $HTTPD))
declare -xr HTTPD_ROOT=$(pwd)


# Apache says it NOT include trailing slash
declare -xr HTTPD_DOCUMENT_ROOT="${HTTPD_ROOT}/www"
declare -xr PHP_ROOT="${HTTPD_ROOT}/etc/php72/"
declare -xr DNSMASQ_PID="${HTTPD_ROOT}/var/run/dnsmasq.pid"
declare -xr HTTPD_PID="${HTTPD_ROOT}/var/run/httpd.pid"
:
export DNS_RESOLV="${HTTPD_ROOT}/etc/resolv.conf"
export DNS_HOSTS="${HTTPD_ROOT}/etc/hosts"


# Configs
declare -xr HTTPD_CONFIG="${HTTPD_ROOT}/conf/httpd.conf"
declare -xr DNSMASQ_CONFIG="${HTTPD_ROOT}/etc/dnsmasq.conf"




declare -A D
D[proc]='dnsmasq'
D[port]="${DNS_PORT}"
D[pid]="${DNSMASQ_PID}"

declare -A H
export H
H[proc]='httpd'
H[port]="${HTTPD_PORT}"
H[pid]="${HTTPD_PID}"





# unncessary
#PHP_CONFIG="${PHP_ROOT}/php-dev.ini"


  # The install paths have been changed to no longer violate the MacPorts mtree:

  #   1. The binaries are now under /opt/local/sbin/
  #      (rather than under /opt/local/apache2/bin/)

  #   2. The configure files are now under /opt/local/etc/apache2/
  #      (rather than under /opt/local/apache2/conf/)

  #   3. The modules are now under /opt/local/lib/apache2/modules/
  #      (rather than under /opt/local/apache2/modules/)

  #   4. The web root is now located under /opt/local/www/apache2/html/
  #      (rather than under /opt/local/apache2/htdocs/)

  #   5. The cgi-bin is now located under /opt/local/www/apache2/cgi-bin/
  #      (rather than under /opt/local/apache2/cgi-bin/)

  #   6. The logs are now located under /opt/local/var/log/apache2/
  #      (rather than under /opt/local/apache2/logs/)

  #   7. The manual is now located under /opt/local/www/apache2/manual/
  #      (rather than under /opt/local/apache2/manual/)

  #   8. The manual (man) pages are still at /opt/local/share/apache2/man/

  #   You can move your htdocs and cgi-bin to the new locations, or edit /opt/local/etc/apache2/httpd.conf to point at the old locations.
